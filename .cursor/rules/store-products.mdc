---
description: Store products and CRUD behavior
alwaysApply: false
globs: context/StoreContext.tsx, lib/store-products.ts, constants.ts, pages/Admin.tsx, components/admin/ProductBulkOperations.tsx
---

# Store Products

When working with store products, CRUD, or product sync:

## Source of truth

- **Supabase configured**: Products come from the `products` table. Supabase is the source of truth. Do not add from `ALL_PRODUCTS` when products were loaded from Supabase (would re-add deleted products).
- **No Supabase**: Use `ALL_PRODUCTS` from constants as seed. `syncProductsFromConstants` adds new products from constants only when not using Supabase.

## Delete behavior

- `deleteProduct` must throw on Supabase error so Admin can show `showError`.
- Do not call `syncProductsFromConstants` when `productsLoadedFromSupabaseRef` is true.

## Sync logic (`lib/store-products.ts`)

- `syncProductsFromConstants(current, seed)` adds only products in `seed` that are not in `current`. It never removes products.
- **Never call sync when Supabase is configured.** When `isSupabaseConfigured()` is true, the sync effect must return early. Calling sync when DB is source would re-add deleted products (constants include seed items like Faith Over Fear Tee, Scripture Wristbands).
- See `docs/STORE_PRODUCT_DELETE_LESSONS.md` for the incident and prevention.

## Deterministic verification

- `e2e/admin-product-delete-persistence.spec.ts` proves delete persists to DB: insert via Supabase → delete via Admin UI → assert product gone from DB.
